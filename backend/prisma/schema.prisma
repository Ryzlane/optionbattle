// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Password reset
  resetToken        String?   @unique
  resetTokenExpires DateTime?

  // Relations
  battles Battle[]
  badges  Badge[]
  collaborations Collaboration[]
  invitationsSent Collaboration[] @relation("Invitations")
  shareLinks     ShareLink[]
  activities     Activity[]

  // Arena relations
  arenas                          Arena[]
  arenaCollaborations             ArenaCollaboration[]
  arenaCollaborationInvitationsSent ArenaCollaboration[]  @relation("ArenaCollaborationInvitations")
  arenaShareLinks                 ArenaShareLink[]
  arenaActivities                 ArenaActivity[]
  arenaInvitationsSent            ArenaInvitation[] @relation("ArenaInvitationsSent")

  // Feedback
  feedbacks Feedback[]

  @@map("users")
}

// Battle model (ex-Decision)
model Battle {
  id          String   @id @default(uuid())
  title       String
  description String?
  status      String   @default("draft") // draft, active, completed, archived
  championId  String?  // ID du fighter vainqueur
  userId      String
  arenaId     String?  // Optional: belongs to an arena
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  arena    Arena?    @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  fighters Fighter[]
  collaborations Collaboration[]
  shareLinks     ShareLink[]
  activities     Activity[]

  @@index([userId])
  @@index([status])
  @@index([arenaId])
  @@map("battles")
}

// Fighter model (ex-Option)
model Fighter {
  id          String   @id @default(uuid())
  name        String
  description String?
  score       Int      @default(0) // Score de combat calculé
  order       Int      @default(0) // Ordre d'affichage
  battleId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  battle    Battle     @relation(fields: [battleId], references: [id], onDelete: Cascade)
  arguments Argument[]

  @@index([battleId])
  @@map("fighters")
}

// Argument model (powers/weaknesses)
model Argument {
  id        String   @id @default(uuid())
  text      String
  type      String // "power" (ex-pro) ou "weakness" (ex-con)
  weight    Int      @default(3) // 1-5 (Power Level)
  fighterId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  fighter Fighter @relation(fields: [fighterId], references: [id], onDelete: Cascade)

  @@index([fighterId])
  @@map("arguments")
}

// Badge model (gamification)
model Badge {
  id         String   @id @default(uuid())
  badgeType  String // first-blood, veteran, champion, etc.
  userId     String
  unlockedAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeType]) // Un badge par type par user
  @@index([userId])
  @@map("badges")
}

// Template model (Quick Battles)
model Template {
  id          String   @id @default(uuid())
  name        String
  description String
  category    String // career, life, tech, finance, health
  icon        String? // Emoji ou icon name
  fighters    String // JSON stringifié : [{ name, description, arguments: [{ text, type, weight }] }]
  createdAt   DateTime @default(now())

  @@map("templates")
}

// Collaboration model - Lien User ↔ Battle avec rôle
model Collaboration {
  id        String   @id @default(uuid())
  battleId  String
  userId    String
  role      String   @default("editor") // owner, editor, viewer
  invitedBy String?
  joinedAt  DateTime @default(now())
  lastSeenAt DateTime @default(now())

  // Relations
  battle Battle @relation(fields: [battleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  inviter User? @relation("Invitations", fields: [invitedBy], references: [id])

  @@unique([battleId, userId])
  @@index([battleId])
  @@index([userId])
  @@map("collaborations")
}

// ShareLink model - Liens partageables avec token
model ShareLink {
  id        String   @id @default(uuid())
  battleId  String
  token     String   @unique
  role      String   @default("viewer")
  expiresAt DateTime?
  createdBy String
  createdAt DateTime @default(now())
  usageCount Int     @default(0)
  maxUsage  Int?

  // Relations
  battle  Battle @relation(fields: [battleId], references: [id], onDelete: Cascade)
  creator User   @relation(fields: [createdBy], references: [id])

  @@index([token])
  @@index([battleId])
  @@map("share_links")
}

// Activity model - Log des actions collaboratives
model Activity {
  id        String   @id @default(uuid())
  battleId  String
  userId    String
  action    String
  entityType String?
  entityId  String?
  metadata  String?
  createdAt DateTime @default(now())

  // Relations
  battle Battle @relation(fields: [battleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([battleId])
  @@index([userId])
  @@map("activities")
}

// Arena model - Workspace collaboratif
model Arena {
  id          String   @id @default(uuid())
  title       String
  description String?
  status      String   @default("active") // active, archived
  userId      String   // Owner
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  battles         Battle[]
  collaborations  ArenaCollaboration[]
  shareLinks      ArenaShareLink[]
  activities      ArenaActivity[]
  invitations     ArenaInvitation[]

  @@index([userId])
  @@index([status])
  @@map("arenas")
}

// ArenaCollaboration model - Permissions au niveau arène
model ArenaCollaboration {
  id         String   @id @default(uuid())
  arenaId    String
  userId     String
  role       String   @default("editor") // owner, editor, viewer
  invitedBy  String?
  joinedAt   DateTime @default(now())
  lastSeenAt DateTime @default(now())

  // Relations
  arena    Arena  @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  inviter  User?  @relation("ArenaCollaborationInvitations", fields: [invitedBy], references: [id])

  @@unique([arenaId, userId])
  @@index([arenaId])
  @@index([userId])
  @@map("arena_collaborations")
}

// ArenaShareLink model - Liens partageables pour arènes
model ArenaShareLink {
  id         String    @id @default(uuid())
  arenaId    String
  token      String    @unique
  role       String    @default("viewer")
  expiresAt  DateTime?
  createdBy  String
  createdAt  DateTime  @default(now())
  usageCount Int       @default(0)
  maxUsage   Int?

  // Relations
  arena   Arena @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  creator User  @relation(fields: [createdBy], references: [id])

  @@index([token])
  @@index([arenaId])
  @@map("arena_share_links")
}

// ArenaActivity model - Log des actions dans l'arène
model ArenaActivity {
  id         String   @id @default(uuid())
  arenaId    String
  userId     String
  action     String
  entityType String?
  entityId   String?
  metadata   String?
  createdAt  DateTime @default(now())

  // Relations
  arena Arena @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([arenaId])
  @@index([userId])
  @@map("arena_activities")
}

// ArenaInvitation model - Invitations avec acceptation
model ArenaInvitation {
  id        String   @id @default(uuid())
  arenaId   String
  email     String
  role      String   @default("editor") // editor, viewer
  token     String   @unique // Token pour acceptation (nanoid 10 chars)
  status    String   @default("pending") // pending, accepted, rejected
  expiresAt DateTime // 7 jours par défaut
  invitedBy String
  createdAt DateTime @default(now())

  // Relations
  arena    Arena @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  inviter  User  @relation("ArenaInvitationsSent", fields: [invitedBy], references: [id])

  @@unique([arenaId, email]) // 1 invitation active par email par arène
  @@index([token])
  @@index([email])
  @@index([status])
  @@map("arena_invitations")
}

// Feedback model - Retours utilisateurs
model Feedback {
  id          String   @id @default(uuid())
  userId      String?
  email       String?
  message     String?  @db.Text
  screenshot  String?  @db.Text
  pageUrl     String
  userAgent   String?
  status      String   @default("pending")
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@map("feedbacks")
}
